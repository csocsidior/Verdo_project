\chapter{System identification design}
\label{identification_design}

\emph{In this chapter, the Multi-inlet, Multi-WT model, which was derived based on first principles in \chapref{system_modelling}, is reformulated such that it is suitable for system identification. First, a model structure is chosen, then a Neural Network(NN) based model is created for identification purposes. In the first case, the identification is carried out on a simple example network, then on the EPANET model of the Randers WSS. Lastly, the identification is evaluated on measurements from the real-world network.}

\section{Model structure of the Multi-inlet, Multi-WT system}
\label{model_structure_of_the_multi_inlet_multi_WT_system}

In \chapref{system_modelling}, a non-linear SS model has been derived, describing the dynamics with multiple inlets and multiple WTs, constrained by the static part of the network. This model description serves as a starting point for the system identification, therefore let us recall the output equation. The output vector $\bar{p}_{\mathcal{K}}$ is given by \eqref{recall_output_eq}

\begin{equation}
  \label{recall_output_eq}
  \bar{p}_{\mathcal{K}} = K^T \bar{H}^{-T}_{\mathcal{T}}f_{\mathcal{T}}(A_2 q_\mathcal{C} + A_3 K \bar{d}_{\mathcal{K}} - A_3 D v_{\mathcal{D}} \sigma) - K^T\bar{H}^{-T}_{\mathcal{T}}\hat{H}^{T}_{\mathcal{T}} (\hat{p} + \hat{h}) - K^T\bar{h} ,
\end{equation} 

\begin{minipage}[t]{0.4\textwidth}
where\\
\hspace*{8mm} $A_1 = \hat{H}^T_{\mathcal{C}} -\bar{H}^T_{\mathcal{C}}\bar{H}^{-T}_{\mathcal{T}}\hat{H}^T_{\mathcal{T}}$, \vspace*{1.5mm}  \\
\hspace*{8mm} $A_2 = -\bar{H}^{-1}_{\mathcal{T}} \bar{H}_{\mathcal{C}} $, \vspace*{1.5mm}\\
\hspace*{8mm} $A_3 = \bar{H}^{-1}_{\mathcal{T}}$.
\end{minipage}

Furthermore, lets recall the constraint on $q_\mathcal{C}$ given by \eqref{meshresult2_WT_model1}

 \begin{equation}
\label{recall_constraint eq}
f_{\mathcal{C}}(q_\mathcal{C}) - A_1(\hat{p} + \hat{h}) + A_2^T f_{\mathcal{T}}(A_2 q_\mathcal{C} + A_3 K \bar{d}_{\mathcal{K}} - A_3 D v_{\mathcal{D}} \sigma) = 0,
\end{equation} 

with $\bar{d}_{\mathcal{K}}$ inlet flows, $\sigma$ total demand, $v_{\mathcal{D}}$ distribution parameter, $q_\mathcal{C}$ flows in set $\mathcal{C}$, $\hat{p}$ pressure in the WTs, $\hat{h}$ elevation of the WTs and $K^T\bar{h} = \bar{h}_{\mathcal{K}} $ the elevation of the pumping stations. For convenience, let us merge the pressure and elevation of the WTs and describe it in the output equation by the total head such that

 \begin{equation}
\label{totalhead_output_eq}
\hat{h}_t = \hat{p} + \hat{h}
\end{equation} 

Although in \chapref{system_modelling} the distribution parameter $v_{\mathcal{D}}$ was assumed to be time-varying, in the further discussion we assume that it is constant. Furthermore, the constraint on $q_\mathcal{C}$ is given by an implicit expression for which solution cannot be given analytically. Therefore, the constraint cannot be explicitly substituted into \eqref{recall_output_eq}, however considering that $q_\mathcal{C}$ is in the form of

 \begin{equation}
\label{qc_abstraction}
q_\mathcal{C} = q_\mathcal{C}(\bar{d}_{\mathcal{K}}, \sigma, \hat{h}_t ),
\end{equation} 

we can see that the dependencies for the $q_\mathcal{C}$ flows are the same as for the output vector, i.e the output model. The total demand $\sigma$ and the the inlet flows $\bar{d}_{\mathcal{K}}$ enter the model in a non-linear way and the total head of the WTs $\hat{h}_t$ enter the system linearly. Due to this, an equivalent form of the output equation in \eqref{recall_output_eq} can be written such that

 \begin{equation}
  \label{recall_output_eq_2}
  \bar{p}_{\mathcal{K}} = K^T \bar{H}^{-T}_{\mathcal{T}}f_{\mathcal{T}}(A_2 q_\mathcal{C}(\bar{d}_{\mathcal{K}}, \sigma, \hat{h}_t ) + A_3 K \bar{d}_{\mathcal{K}} - A_3 D v_{\mathcal{D}} \sigma) - K^T\bar{H}^{-T}_{\mathcal{T}}\hat{H}^{T}_{\mathcal{T}} \hat{h}_t - \bar{h}_{\mathcal{K}}. 
\end{equation} 

From \eqref{recall_output_eq_2} we can see that although the total head of the WTs $\hat{h}_t$ enters \eqref{recall_output_eq} linearly, after using the constraint on $q_\mathcal{C}$, this dependency becomes non-linear. Furthermore, the linear term in \eqref{recall_output_eq_2} is the elevation of the pumping stations $\bar{h}_{\mathcal{K}}$, which is a constant, known parameter of the system. Therefore, by adding this elevation parameter to the input pressures $\bar{p}_{\mathcal{K}}$, we get the total head as the output. A reformulated output equation can be given such that 

 \begin{equation}
  \label{recall_output_eq_3}
  \tilde{y} = \bar{p}_{\mathcal{K}} + \bar{h}_{\mathcal{K}} = \tilde{f}_1(\bar{d}_{\mathcal{K}}, \sigma, \hat{h}_t ). 
\end{equation} 

This static model described in \eqref{recall_output_eq_3} is a mapping defined by the function $\tilde{f}_1$, which maps the input set, $u = \{ \bar{d}_{\mathcal{K}}, \sigma, \hat{h}_t \}$ to the outputs $\tilde{y}$. In the input set, the total consumption can be calculated back from the mass-balance equation written up for the whole network such that

\begin{equation}
\label{massbalance_identification}
 \sigma = 1^T \hat{d} + 1^T \bar{d}_{\mathcal{K}}.
\end{equation}

With this, we assume that the flows in the WTs are measured. Nevertheless, the input and output set together forms the TS $\mathcal{D}_1 = \{u_i ; \tilde{y}_i\}_{i = 1,2, ..., N}$, which can be utilized to carry out the identification on the model. 

Now, lets recall the equation describing the dynamics. As it was explained in \chapref{system_modelling}, the states of the system are the pressures $\hat{p}$ in the WTs. Recalling \eqref{WT_matrixform_final} in discrete form the following is given

\begin{equation}
\label{WT_matrixform_final_discrete}
\Lambda \hat{p}_{k+1} = - (\hat{H}_{\mathcal{C}} - \hat{H}_{\mathcal{T}} \bar{H}^{-1}_{\mathcal{T}}\bar{H}_{\mathcal{C}})  q_{\mathcal{C},k}  - \hat{H}_{\mathcal{T}} \bar{H}^{-1}_{\mathcal{T}} K \bar{d}_{\mathcal{K},k} + \hat{H}_{\mathcal{T}} \bar{H}^{-1}_{\mathcal{T}} D v_{\mathcal{D}} \sigma_k.
\end{equation}

Substituting the constraint on $q_{\mathcal{C}}$ into \eqref{WT_matrixform_final_discrete}, without merging the WT pressure and elevation variables, the following dynamics description can be given

\begin{equation}
\label{WT_matrixform_final_discrete1}
\Lambda \hat{p}_{k+1} = - (\hat{H}_{\mathcal{C}} - \hat{H}_{\mathcal{T}} \bar{H}^{-1}_{\mathcal{T}}\bar{H}_{\mathcal{C}})  q_\mathcal{C}(\bar{d}_{\mathcal{K},k}, \sigma_k, \hat{p}_k, \hat{h})  - \hat{H}_{\mathcal{T}} \bar{H}^{-1}_{\mathcal{T}} K \bar{d}_{\mathcal{K},k} + \hat{H}_{\mathcal{T}} \bar{H}^{-1}_{\mathcal{T}} D v_{\mathcal{D}} \sigma_k.
\end{equation}

The state equation in \eqref{WT_matrixform_final_discrete} describes a linear combination of the inputs, however by substituting the $q_\mathcal{C}$ flows, it is shown that the inlet flows $\bar{d}_{\mathcal{K}}$ and total consumption $\sigma$ effects the states in a non-linear manner. Besides that, the future state values linearly depend on the present values of the states $\hat{p}$ and the elevation of the WTs $\hat{h}$. With this in mind, similarly as it was done for the output equation, the state equation can be reformulated, such that 

\begin{equation}
\label{WT_matrixform_final_discrete2}
\hat{p}_{k+1} = \tilde{f}_2(\bar{d}_{\mathcal{K},k}, \sigma_k) + a_1 \hat{p}_k + a_2 \hat{h},
\end{equation}

where $\tilde{f}_2$ is a non-linear function, describing the dependencies of the inlet flows $\bar{d}_{\mathcal{K}}$ and the total consumption $\sigma$ on the next state. $a_1$ and $a_2$ describe parameters for the linear terms. Furthermore, the TS $\mathcal{D}_2$ corresponding to the state equation, can be built up the same way as it was done for the output equation. 

The complete identification model consists of the static output equation and the state equation describing the dynamics in the form of

\begin{equation}
\begin{cases}
  \label{identification_model}
    \tilde{y}  = \tilde{f}_1(\bar{d}_{\mathcal{K}}, \sigma, \hat{h}_t )\\
  \hat{p}_{k+1} = \tilde{f}_2(\bar{d}_{\mathcal{K},k}, \sigma_k) + a_1 \hat{p}_k + a_2 \hat{h} .
  \end{cases}
\end{equation} 

It is important to point out that the presented model for identification is linear in the parameters, meaning that they can be estimated by linear optimization. For the linear optimization, only the parameters have to enter linearly, as the input can depend in any non-linear way on the input data sets. 

The main goal of the system identification therefore, is to find the realization of $\tilde{f}_1$ and $\tilde{f}_2$, furthermore to find the parameters $a_1$, $a_2$ such that the identified model fits the TSs $\mathcal{D}_{1}$ and $\mathcal{D}_{2}$. The tools for carrying out such identification procedure leads to the discussion of basis functions and neural networks, which are introduced and discussed in the following sections.   

\section{RBFNN model of the Multi-inlet,Multi-WT system}
\label{RBFNN_model_multi_inlet_multi_WT_sys} 

As the tools for identification has been introduced in \appref{neural_networks} , the interpretation of the Multi-inlet, Multi-WT system in the context of NNs is considered. In order to formulate a NN structure, let us first recall the system equations, described in \secref{model_structure_of_the_multi_inlet_multi_WT_system}. The corresponding output and state equations are shown in \eqref{identification_model11}. 

\begin{equation}
\begin{cases}
  \label{identification_model11}
    \tilde{y}  = \tilde{f}_1(\bar{d}_{\mathcal{K}}, \sigma, \hat{h}_t )\\
  \hat{p}_{k+1} = \tilde{f}_2(\bar{d}_{\mathcal{K},k}, \sigma_k) + a_1 \hat{p}_k + a_2 \hat{h} .
  \end{cases}
\end{equation} 

As it was concluded, the output is governed by the non-linear function $\tilde{f}_1$, which maps the inputs $\bar{d}_{\mathcal{K}}$, $\sigma$ and $\hat{h}_t $ to the outputs $\tilde{y}$. This static input-output system can be represented with a RBFNN, shown in \figref{fig:nn_output}.

  %NN model of the output eq.
 \begin{figure}[H]
 \centering
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/output_NN1.tex} 
  \vspace{-7mm}
 \caption{NN model of the output equation.}
 \label{fig:nn_output}
 \end{figure}

 \vspace{-3mm}

 In \figref{fig:nn_output}, the first layer consists of the inputs, the hidden layer forms the set of RBFs and, as there are two outputs in the network. The output layer consists of two output neurons which linearly combine the weighted RBFs. Therefore, the output equation written in RBFNN formulation can be given such that 

  \begin{equation}
\label{NN_output_eq1}
\tilde{y}_1 = \sum_{i = 1}^M w_i \phi_i(u) +  w_{0,1},
\end{equation}

where $u = (\bar{d}_{\mathcal{K}} \ \sigma \ \hat{h}_t )^T$. Using vector notation, \eqref{NN_output_eq1} can be rewritten such that

  \begin{equation}
\label{NN_output_vector1}
\tilde{y} = \theta^T_{\tilde{y}} 
          \begin{pmatrix}
           \phi_1(u) \\[1pt]
           \phi_2(u) \\[1pt]
           \vdots \\[1pt]
           \phi_M(u)\\[3pt]
           1 
         \end{pmatrix}
         =
         \theta^T_{\tilde{y}} \chi_{\tilde{y}},
\end{equation}

where $\theta_{\tilde{y}}$ is the regression matrix, including the output weights $w_i$ and the biases $w_0$. Furthermore, $\theta$ has as many columns as the number of inputs. $\chi_{\tilde{y}}$ is called the regressor vector, or in NN context the input vector, consisting of the basis functions and the vector $1 \in \: \mathbb{R}^{c} $, where $c$ is the number of outputs. 

The state equation is governed by the non-linear function $\tilde{f}_2$ and furthermore, the states $\hat{p}$ and the elevation of the WTs $\hat{h}$ enter the system linearly. As a consequence of this, the measured data of the states have a strong linear component. In the NN representation this is taken into account such that skip-layer connections are introduced. These extra connections in the NN model are skipping the hidden layer, thereby contribute linearly to the outputs. The illustration of such RBFNN is shown in \figref{fig:nn_state}.

   %NN model of the state eq.
 \begin{figure}[H]
 \centering
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/output_NN.tex} 
 \caption{NN model of the state equation.}
 \label{fig:nn_state}
 \end{figure}

 \vspace{-3mm}

 In \figref{fig:nn_state}, although the input neurons for the skip-layer connections are placed in line with the hidden layer, they are considered as simple inputs, effecting the output layer by the parameters $a_1$ and $a_2$. Nevertheless, the identification is treated as a black-box model, but since insight is given about the network architecture, the NN model can be better matched to the problem by utilizing these skip-layer connections. Furthermore, in \figref{fig:nn_state}, the inputs are all present values and the outputs are the future or predicted values of the states $\hat{p}_{k+1}$. $\hat{h}$ does not have a time step index, as this value is the elevation of WTs, which is time-invariant. 

 Using vector notation, the NN model for the state equation can be given in the form as shown in \eqref{NN_state_vector2}

  \begin{equation}
\label{NN_state_vector2}
\hat{p}_{k+1} = \theta^T_{\hat{p}} 
          \begin{pmatrix}
           \phi_1(u_k) \\[1pt]
           \phi_2(u_k) \\[1pt]
           \vdots \\[1pt]
           \phi_M(u_k)\\[3pt]
           \hat{p}_k \\
           \hat{h}\\
           1 
         \end{pmatrix}
         =
         \theta^T_{\hat{p}} \chi_{\hat{p}},
\end{equation}

where $\theta^T_{\hat{p}}$ is the regression matrix, including the output weights $w_i$, the skip-layer connection weights $a_i$ and the biases $w_0$. The regressor vector $\chi_{\hat{p}}$ consists of the basis functions, the linear inputs $\hat{p}_k$ and $\hat{h}$ and the vector $1 \in \: \mathbb{R}^{l} $, where $l$ is the number of states.




