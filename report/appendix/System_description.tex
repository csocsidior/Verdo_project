\chapter{RBFNN-based identification on an example network}
\label{NN_based_example}

\emph{In this part, the test results of the chosen identification method are presented on a simple EPANET example. }

\section{The network in EPANET}
\label{example1_EPANET}

A simple test network in EPANET has been used for testing the presented identification method. On a real world network, typically the operation or control cannot be taken to its extremes, as this would result in undesired service to the customers. Therefore, the network shown in \figref{fig:epanet_example1_id} has been created to mimic the behaviour of a multi-inlet, single-WT system, such that the identification method, presented in \chapref{identification_design}, can be be tested under different operations. 

%EPANET example network for identification
\begin{figure}[H]
\centering
%\includegraphics[width=0.6\textwidth]{report/pictures/example1_epanetmodel}
\input{report/tikz/example1_id.tex} 
\caption{Multi-inlet, Single-WT example network.}
\label{fig:epanet_example1_id}
\end{figure}
\vspace{-3mm}

The network shown in \figref{fig:epanet_example1_id} consists of two pumping stations $PU_1$, $PU_2$ and a Water Tank $TA$. It should be noted that reservoirs $RE_1$ and $RE_2$ are required for simulating the pumps, however they differ from WTs in the sense that they cannot be emptied in the simulation. It is important to note that the physical parameters and numerical values do not represent any existing physical network, therefore quantitatively the values might be unrealistic compared to real world scenarios. The physical and operational properties of the test system can be found in \appref{physical_properties_example1}.

The controls implemented on the network are based on simple time scheduling of the two pumping stations. Both pumps turn off when the pressure head in the WT is above a certain limit. $PU_2$ turns on again if the pressure head in the WT decreases to some lower limit. Furthermore, $PU_2$ turns on again only if the pressure head provided by $PU_2$ exceeds some upper bound. 

\section{Identification and validation}
\label{identification_and_validation_of_the_output_eq} 

The identification is carried out on the simulation data, exported from EPANET. In order to validate the identified model, different control and consumption scenarios have been considered. Thus, in the first case of the validation, the model is tested by modifying the total consumption. In the second case, the consumption has been kept the same as for in the case of the identification, however the control properties of $PU_1$ and $PU_2$ has been modified. The two different consumption curves are both periodic with a time period of 24 hours and have the same characteristics. \figref{fig:sigma123} shows the $\sigma_1$ and $\sigma_2$ total consumption curves. 

  %Total consumptions
 \begin{figure}[H]
 \centering
 %\hspace{0mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net/sigma123.tex} 
 \vspace{-2.5mm}
 \caption{Consumption patterns used for identification and validation.}
 \label{fig:sigma123}
 \end{figure}

 \vspace{-3mm}

 \subsection{Identification}
 \label{identification}

 The identification has been carried out such that the total consumption in the network is $\sigma_1$. Furthermore, the control of the pumping stations is the following: both $PU_1$ and $PU_2$ shut down if the pressure head in the WT exceeds 19.85 meters. $PU_1$ turns on when the pressure head in the WT decreases to 19.55 meters and $PU_2$ turns on again only if the pressure head delivered by $PU_1$ is above 43 meters. The corresponding flow inputs $\bar{d}_{\mathcal{K}1}$, $\bar{d}_{\mathcal{K}2}$ and the pressure head in the WT $\hat{p}$ are shown in \figref{fig:identification_example1}.

 \vspace{-3mm}

   %Inlet flow - identification
 \begin{figure}[H]
 \centering
 %\hspace{0mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/dk.tex} 
 \vspace{-2.5mm}
 %\caption{Inlet flows of $PU_1$ and $PU_2$.}
 \end{figure}

 \vspace{-5mm}

   %WT - identification
 \begin{figure}[H]
 \centering
 \hspace{-4.5mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/WT.tex} 
 \vspace{-2.5mm}
 \caption{Inlet flows(above) and the pressure in the WT(below) under $\sigma_1$ total demand.}
 \label{fig:identification_example1}
 \end{figure}

 \vspace{-3mm}


 \subsection{Validation 1}
 \label{validation_1}

 The first validation of the identified model has been carried out such that the total consumption is reduced to $\sigma_2$. The control properties are unchanged. The corresponding flow inputs $\bar{d}_{\mathcal{K}1}$, $\bar{d}_{\mathcal{K}2}$ and the pressure head in the WT $\hat{p}$ are shown in \figref{fig:identification_example1_v1}. 

 \vspace{-3mm}

   %Inlet flow - v1
 \begin{figure}[H]
 \centering
 %\hspace{0mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/dk_v1.tex} 
 \vspace{-2.5mm}
 %\caption{Inlet flows of $PU_1$ and $PU_2$.}
 \end{figure}

 \vspace{-5.5mm}

   %WT - sigma1
 \begin{figure}[H]
 \centering
 \hspace{-4.5mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/WT_v1.tex} 
 \vspace{-2.5mm}
 \caption{Inlet flows(above) and the pressure in the WT(below) under $\sigma_2$ total demand.}
 \label{fig:identification_example1_v1}
 \end{figure}

 \vspace{-3mm}

 As the consumer demand is reduced in the network, the pumping stations do not have to provide as much flow as in case of the identification. Therefore, the WT has a slower filling and emptying rate. 

 \subsection{Validation 2}
 \label{validation_2}

 In case of the second validation, the total consumption is $\sigma_1$, however the network is tested on different control properties. Thus, both $PU_1$ and $PU_2$ shut down if the pressure head in the WT exceeds 19.4 meters. $PU_1$ turns on when the pressure head in the WT decreases to 19.2 meters and $PU_2$ turns on again only if the pressure head delivered by $PU_1$ is above 48 meters. The corresponding flow inputs $\bar{d}_{\mathcal{K}1}$, $\bar{d}_{\mathcal{K}2}$ and the pressure head in the WT $\hat{p}$ are shown in \figref{fig:identification_example1_v2}.

 \vspace{-3mm}

   %Inlet flow - v2
 \begin{figure}[H]
 \centering
 %\hspace{0mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/dk_v2.tex} 
 \vspace{-2.5mm}
 %\caption{Inlet flows of $PU_1$ and $PU_2$.}
 \end{figure}

 \vspace{-5.5mm}

   %WT -v2
 \begin{figure}[H]
 \centering
 \hspace{-4.5mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/WT_v2.tex} 
 \vspace{-2.5mm}
 \caption{Inlet flows(above) and the pressure in the WT(below) under $\sigma_1$ total demand and under modified control properties.}
 \label{fig:identification_example1_v2}
 \end{figure}

 \vspace{-3mm}

 \subsection{Output model}
 \label{output model}

For the two inlet pressures $\bar{p}_{\mathcal{K}1}$ and $\bar{p}_{\mathcal{K}2}$, the identification has been carried out with six RBF neurons. The performance goal has been chosen to the order of $10^{-3}$. \figref{fig:MSE_output} shows the mean of squared errors in terms of RBF neurons. 

   %MSE output
 \begin{figure}[H]
 \centering
 %\hspace{0mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/output_perf.tex} 
 \vspace{-2.5mm}
 \caption{The networkâ€™s performance according to the mean of squared errors.}
 \label{fig:MSE_output}
 \end{figure}

 \vspace{-4mm}

The performance goal can be reached with introducing more RBF neurons, however it does not generalize the model as well as six neurons. In case of increasing the number of neurons, and change the spread parameter of the RBFs, the identification has resulted in overfit and the validation has given bad performance. The identification of $\bar{p}_{\mathcal{K}1}$ and $\bar{p}_{\mathcal{K}2}$ inlet pressures in case of $\sigma_1$ total demand is shown in \figref{fig:pk_ident}. The two validations are shown in \figref{fig:pk_v1_ident}  and \figref{fig:pk_v2_ident}, respectively. 

   %pk1 - pk2 
 \begin{figure}[H]
 \centering
 %\hspace{-10mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/pk.tex} 
 \vspace{-2.5mm}
 \caption{Identification of $\bar{p}_{\mathcal{K}1}$ and $\bar{p}_{\mathcal{K}2}$.}
 \label{fig:pk_ident}
 \end{figure}

 \vspace{-4mm}

 As can be seen in \figref{fig:pk_ident}, the inlet pressures $\bar{p}_{\mathcal{K}1}$ and $\bar{p}_{\mathcal{K}2}$ of the identified model and the measurements are almost identical. 

 \vspace{-2mm}

   %pk1 - pk2 v1
 \begin{figure}[H]
 \centering
 %\hspace{-10mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/pk_v1.tex} 
 \vspace{-2.5mm}
 \caption{Validation 1.}
 \label{fig:pk_v1_ident}
 \end{figure}

 \vspace{-4mm}

 In \figref{fig:pk_v1_ident}, the largest difference between the measurement data and the model is at times when both pumping stations shut down. Although at these times the inlet flow is zero, the model reacts well for the changes of the total consumption and the pressure in the WT.

  \vspace{-2mm}

   %pk1 - pk2 v1
 \begin{figure}[H]
 \centering
 %\hspace{-10mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/pk_v2.tex} 
 \vspace{-2.5mm}
 \caption{Validation 2.}
 \label{fig:pk_v2_ident}
 \end{figure}

 \vspace{-4mm}

In \figref{fig:pk_v2_ident}, the model shows good results in case if the pumps shut down and turn on for different WT levels and inlet pressures. Similarly to Validation 1, the biggest difference between the model and measurement are at times when both pumps are completely shut down. 

 \subsection{State model}
 \label{state_model}

For the WT pressure $\hat{p}$, the identification has been carried out with five RBF neurons on the difference of the current and the next pressure head. \figref{fig:MSE_state}shows the mean squared errors in terms of RBF neurons on the identified network model.

\vspace{-1mm}

  %MSE state
 \begin{figure}[H]
 \centering
 %\hspace{0mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/state_perf.tex} 
 \vspace{-3.5mm}
 \caption{The networkâ€™s performance according to the mean of squared errors.}
 \label{fig:MSE_state}
 \end{figure}

 \vspace{-3mm}

 \figref{fig:MSE_state} shows, that using more neurons in the model, does not improve the performance significantly. The result of identification is shown in \figref{fig:p_WT_ident}. The two validation results are shown in \figref{fig:p_WT_ident_v1} and \figref{fig:p_WT_ident_v2}, respectively. 

   %p_WT (k+1) - p_WT(k)
 \begin{figure}[H]
 \centering
 %\hspace{0mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/p_WT.tex} 
 \vspace{-3.5mm}
 \caption{Identification of $\hat{p}^{(k+1)} - \hat{p}^{(k)}$.}
 \label{fig:p_WT_ident}
 \end{figure}

 \vspace{-4mm}

    %p_WT (k+1) - p_WT(k)
 \begin{figure}[H]
 \centering
 %\hspace{0mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/p_WT_v1.tex} 
 \vspace{-3.5mm}
 \caption{Validation 1.}
 \label{fig:p_WT_ident_v1}
 \end{figure}

 \vspace{-4mm}

   %p_WT (k+1) - p_WT(k)
 \begin{figure}[H]
 \centering
 \hspace{6mm}
 %\includegraphics[width=0.35\textwidth]{report/pictures/missingfigure}
 \input{report/tikz/example_net_final/p_WT_v2.tex} 
 \vspace{-2.5mm}
 \caption{Validation 2.}
 \label{fig:p_WT_ident_v2}
 \end{figure}

 \vspace{-4mm}

The output parameter vectors $\theta_{\mathcal{K}1}$, $\theta_{\mathcal{K}2}$ and the state parameter vector $\theta_{\mathcal{S}1}$, including the output weights, linear parameters and biases are shown in \eqref{par_matrices_output_example123}.

\vspace{-2mm}

 \begin{equation}
\label{par_matrices_output_example123}
         \theta_{\mathcal{K}1} = 
          \begin{pmatrix}
           -321.27  \\
           -101.81  \\
           -391.47  \\
           -382.66  \\
           -4.48 \cdot 10^6  \\
           4.55 \cdot 10^6 \\
           9.23 \cdot 10^3 \\
           4.48 \cdot 10^6 \\
           394.62 \\
           -4.57 \cdot 10^6\\
           -0.27 \\
           37.33 \\
         \end{pmatrix}
         ,
         \hspace{5mm}
         \theta_{\mathcal{K}2} = 
          \begin{pmatrix}
           -102.36  \\
           10.88  \\
           -89.94  \\
           115.19  \\
           -3.28 \cdot 10^5  \\
           1.42 \cdot 10^5 \\
           -1.78 \cdot 10^3 \\
           3.27 \cdot 10^5 \\
           35.35 \\
           -1.39 \cdot 10^5\\
           -0.33 \\
           60.14 \\
         \end{pmatrix}
\hspace{5mm}
         \theta_{\mathcal{S}1} = 
          \begin{pmatrix}
           4.15 \cdot 10^{3} \\
            2.64 \cdot 10^{4} \\
             -5.15 \cdot 10^{4} \\
              2.51 \cdot 10^{4} \\
               0.42 \\
                -4.15 \cdot 10^{3} \\
                  3.4 \cdot 10^{-3} \\
                   -8.08 \cdot 10^{-4} \\
                   -5.8 \cdot 10^{-3} \\
                    0.16 

         \end{pmatrix}
\end{equation}

\chapter{Test network description}
\label{physical_properties_example1}

\emph{In this part of the appendix, the corresponding physical parameters, control properties and consumption properties are listed for the Multi-inlet, Single-WT example network.}

In order to describe the network, the IDs shown in \figref{fig:epanet_example1_id} and in \figref{fig:epanet_example1_id_pipes} are used to identify the corresponding pipes and measurement points in the network. 

%EPANET example network for identification
\begin{figure}[H]
\centering
%\includegraphics[width=0.6\textwidth]{report/pictures/example1_epanetmodel}
\input{report/tikz/example_network_edges.tex} 
\caption{Pipe IDs in the test network.}
\label{fig:epanet_example1_id_pipes}
\end{figure}
\vspace{-3mm}

The physical properties of pipes are shown in \tabref{pipes_table_example1}.

\vspace{-3mm}

\begin{center}
    \begin{tabular}{ | >{\centering\arraybackslash}m{1.8cm} | >{\centering\arraybackslash}m{3.6cm} | >{\centering\arraybackslash}m{3.6cm} | >{\centering\arraybackslash}m{3.6cm} |}
    \hline
    \multirow{1}{*}
     Pipe ID & Length, l[m] & Diameter, D[mm] & Roughness, $\epsilon$[mm] \\ 
     \hline
     \multirow{1}{*}
    \text{$e_1$} & 350 & 200 & 50 \\ 
    \hline
      \multirow{1}{*}
    \text{$e_2$} & 500 & 200  & 150 \\ 
    \hline
      \multirow{1}{*}
    \text{$e_3$} & 500 & 200 & 30 \\ 
    \hline
      \multirow{1}{*}
    \text{$e_4$} & 350 & 200 & 50 \\ 
    \hline
    \multirow{1}{*}
    \text{$e_5$} & 500 & 200 & 30 \\ 
    \hline
    \multirow{1}{*}
    \text{$e_6$} & 500 & 200 & 10 \\ 
    \hline
    \multirow{1}{*}
    \text{$e_7$} & 350 & 200 & 10 \\ 
    \hline
    \multirow{1}{*}
    \text{$e_8$} & 350 & 200 & 0.005 \\ 
    \hline
    \multirow{1}{*}
    \text{$e_9$} & 350 & 200 & 0.005 \\ 
    \hline
    \multirow{1}{*}
    \text{$e_{10}$} & 350 & 200 & 0.005 \\ 
    \hline
    \multirow{1}{*}
    \text{$e_{11}$} & 350 & 200 & 10 \\ 
    \hline
    \multirow{1}{*}
    \text{$e_{12}$} & 350 & 200 & 50 \\ 
    \hline
    \multirow{1}{*}
    \text{$e_{13}$} & 350 & 200 & 50 \\ 
    \hline
    \multirow{1}{*}
    \text{$e_{14}$} & 350 & 200 & 1 \\ 
    \hline
    \multirow{1}{*}
    \text{$e_{15}$} & 350 & 200 & 0.005 \\ 
    \hline
    \end{tabular}
    \captionof{table}{Physical properties of pipes in the test network.}
    \label{pipes_table_example1}
\end{center}

The pumping stations $PU_1$ and $PU_2$ are described by \eqref{pu1_pumpcurve} and \eqref{pu2_pumpcurve} pump curves, respectively. 


\begin{subequations}

\begin{equation}
\label{pu1_pumpcurve}
h = 53.33 - 0.008334 q^2, 
\end{equation}

\vspace{-2mm}

\begin{equation}
\label{pu2_pumpcurve}
h = 46.67 - 0.009525 q^2. 
\end{equation}

\end{subequations}

Furthermore, the elevation of the WT is 21 meters, the initial level is 19.5 meters, the minimum level is 2 meters and the maximum level is 21 meters. The diameter of the WT is 50 meters. 

The physical properties of the nodes are shown in \tabref{pipes_table_example1_nodes}.

\begin{center}
    \begin{tabular}{ | >{\centering\arraybackslash}m{1.8cm} | >{\centering\arraybackslash}m{3.6cm} | >{\centering\arraybackslash}m{3.6cm} | }
    \hline
    \multirow{1}{*}
     Node ID & Elevation, h[m] & Diameter, D[m]  \\ 
     \hline
     \multirow{1}{*}
    \text{$n_1$} & 0 & 0 \\ 
    \hline
      \multirow{1}{*}
    \text{$n_2$} & 2 & 5   \\ 
    \hline
      \multirow{1}{*}
    \text{$n_3$} & 0 & 0 \\ 
    \hline
      \multirow{1}{*}
    \text{$n_4$} & 0 & 0  \\ 
    \hline
    \multirow{1}{*}
    \text{$n_5$} & 20 & 15 \\ 
    \hline
    \multirow{1}{*}
    \text{$n_6$} & 0 & 5 \\ 
    \hline
    \multirow{1}{*}
    \text{$n_7$} & 0 & 5  \\ 
    \hline
    \multirow{1}{*}
    \text{$n_8$} & 0 & 5  \\ 
    \hline
    \multirow{1}{*}
    \text{$n_9$} & 0 & 0  \\ 
    \hline
    \multirow{1}{*}
    \text{$n_{10}$} & 0 & 0  \\ 
    \hline
    \multirow{1}{*}
    \text{$n_{11}$} & 0 & 0 \\ 
    \hline
    \multirow{1}{*}
    \text{$n_{12}$} & 0 & 0 \\ 
    \hline
    \end{tabular}
    \captionof{table}{Physical properties of nodes in the test network.}
    \label{pipes_table_example1_nodes}
\end{center}